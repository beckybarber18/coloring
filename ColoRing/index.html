<html>

    <head>

        <script src='Box2dWeb.min.js'></script>
        <script src="js/three.js"></script>
        <script src="keyboard.js"></script>
        <script src="jquery.js"></script>
        <script src="js/maze.js"></script>
        <script src="js/render_world.js"></script>
        <script src="js/physics_world.js"></script>

        <script>

            let camera         = undefined,
                scene          = undefined,
                renderer       = undefined,
                light          = undefined,
                mouseX         = undefined,
                mouseY         = undefined,
                arena           = undefined,
                arenaMesh       = undefined,
                arenaDimension  = 100,
                arenaWidth      = 10,
                tileWidth       = 1,
                planeMesh      = undefined,
                ballMesh       = undefined,
                ballRadius     = 2,
                keyAxis        = [0, 0],
                keyAxis2       = [0, 0],
                ironTexture    = new THREE.TextureLoader().load('/ball.png'),
                ironTexture2   = new THREE.TextureLoader().load('/ball2.png'),
                brickTexture   = new THREE.TextureLoader().load('/brick.png'),
                gameState      = undefined,

            // Box2D shortcuts
                b2World        = Box2D.Dynamics.b2World,
                b2FixtureDef   = Box2D.Dynamics.b2FixtureDef,
                b2BodyDef      = Box2D.Dynamics.b2BodyDef,
                b2Body         = Box2D.Dynamics.b2Body,
                b2CircleShape  = Box2D.Collision.Shapes.b2CircleShape,
                b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
                b2Settings     = Box2D.Common.b2Settings,
                b2Vec2         = Box2D.Common.Math.b2Vec2,

            // Box2D world variables
                wWorld         = undefined,
                wBall          = undefined;

                function generateSquareArena(dimension) {

                    function iterate(field, x, y) {
                        field[x][y] = false;
                        while(true) {
                            directions = [];
                            if(x > 1 && field[x-2][y] == true) {
                                directions.push([-1, 0]);
                            }
                            if(x < field.dimension - 2 && field[x+2][y] == true) {
                                directions.push([1, 0]);
                            }
                            if(y > 1 && field[x][y-2] == true) {
                                directions.push([0, -1]);
                            }
                            if(y < field.dimension - 2 && field[x][y+2] == true) {
                                directions.push([0, 1]);
                            }
                            if(directions.length == 0) {
                                return field;
                            }
                            dir = directions[Math.floor(Math.random()*directions.length)];
                            field[x+dir[0]][y+dir[1]] = false;
                            field = iterate(field, x+dir[0]*2, y+dir[1]*2);
                        }
                    }

                    // Initialize the field.
                    var field = new Array(dimension);
                    field.dimension = dimension;
                    for(var i = 0; i < dimension; i++) {
                        field[i] = new Array(dimension);
                        for (var j = 0; j < dimension; j++) {
                            field[i][j] = true;
                        }
                    }

                    // Generate the maze recursively.
                    field = iterate(field, 1, 1);

                    return field;

                }


            function gameLoop() {

                switch(gameState) {

                    case 'initialize':
                        arena = generateSquareArena(arenaDimension);
                        arena[arenaDimension-1][arenaDimension-2] = false;
                        createPhysicsWorld();
                        createRenderWorld();
                        light.intensity = 0;
                        var level = Math.floor((arenaDimension-1)/2 - 4);
                        $('#level').html('Level ' + level);
                        gameState = 'fade in';
                        break;

                    case 'fade in':
                        light.intensity += 0.1 * (1.0 - light.intensity);
                        renderer.render(scene, camera);
                        if (Math.abs(light.intensity - 1.0) < 0.05) {
                            light.intensity = 1.0;
                            gameState = 'play'
                        }
                        break;

                    case 'play':
                        updatePhysicsWorld();
                        updateRenderWorld();
                        renderer.render(scene, camera);

                        // Check for victory.
                        // var arenaX = Math.floor(ballMesh.position.x + 0.5);
                        // var arenaY = Math.floor(ballMesh.position.y + 0.5);
                        // if (arenaX == arenaDimension && arenaY == arenaDimension - 2) {
                        //     arenaDimension += 2;
                        //     gameState = 'fade out';
                        // }
                        break;

                    case 'fade out':
                        updatePhysicsWorld();
                        updateRenderWorld();
                        light.intensity += 0.1 * (0.0 - light.intensity);
                        renderer.render(scene, camera);
                        if (Math.abs(light.intensity - 0.0) < 0.1) {
                            light.intensity = 0.0;
                            renderer.render(scene, camera);
                            gameState = 'initialize'
                        }
                        break;

                }

                requestAnimationFrame(gameLoop);

            }


            function onResize() {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            }


            function onMoveKey(axis) {
                keyAxis = axis.slice(0);
            }

            function onMoveKey2(axis) {
                keyAxis2 = axis.slice(0);
            }

            jQuery.fn.centerv = function () {
                wh = window.innerHeight;
                h = this.outerHeight();
                this.css("position", "absolute");
                this.css("top", Math.max(0, (wh - h)/2) + "px");
                return this;
            }


            jQuery.fn.centerh = function () {
                ww = window.innerWidth;
                w = this.outerWidth();
                this.css("position", "absolute");
                this.css("left", Math.max(0, (ww - w)/2) + "px");
                return this;
            }


            jQuery.fn.center = function () {
                this.centerv();
                this.centerh();
                return this;
            }


            $(document).ready(function() {

                // Prepare the instructions.
                $('#instructions').center();
                $('#instructions').hide();
                KeyboardJS.bind.key('i', function(){$('#instructions').show()},
                                         function(){$('#instructions').hide()});

                // Create the renderer.
                renderer = new THREE.WebGLRenderer();
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);

                // Bind keyboard and resize events.
                KeyboardJS.bind.axis('left', 'right', 'down', 'up', onMoveKey);
                KeyboardJS.bind.axis('h', 'l', 'j', 'k', onMoveKey);
                KeyboardJS.bind.axis('a','d','s','w', onMoveKey2)
                $(window).resize(onResize);


                // Set the initial game state.
                gameState = 'initialize';

                // Start the game loop.
                requestAnimationFrame(gameLoop);

            })



        </script>

        <style>

            body {
                background: black;
                margin: 0;
                padding: 0;
                font-family: 'Helvetica';
            }

            #instructions {
                background-color: rgba(0,0,0,0.75);
                color: white;
                text-align: center;
                padding: 32px;
                margin: 0px;
                display: inline;
                border: 2px solid white;
            }

            #help {
                position: absolute;
                left: 0px;
                bottom: 0px;
                padding: 4px;
                color: white;
            }

            /* #level {
                position: absolute;
                left: 0px;
                top: 0px;
                padding: 4px;
                color: yellow;
                font-weight: bold;
            } */

        </style>

    </head>

    <body>

    <div id='instructions'>
        How to play Astray:
        <br><br>
        Use the arrow keys to move the ball and find the exit to the arena.
        <br><br>
        Vim trainees: h, j, k, l
    </div>

    <div id='help'>
        Hold down the 'I' key for instructions.
    </div>

    <div id='level'>
        Level 1
    </div>

    </body>

</html>
